name: executable-bundle-macos

on:
  release:
    types: [ published ]
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS Executable Bundle
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv pyinstaller
          # Install to global namespace and then clean up, no need for venv setup
          pipenv install --dev --system

      - name: Build and bundle with PyInstaller
        id: build_bundle # ID for accessing outputs
        run: |
          # Generate requirements.txt from Pipfile for pip installation
          pipenv requirements --dev > requirements.txt
          pip install -r requirements.txt

          # Run PyInstaller to create the executable bundle
          pyinstaller --distpath=./dist/appdynamics backend/config-assessment-tool.spec

          # Navigate to dist directory
          cd dist

          # Fix code signing for macOS (Ad-hoc signing with entitlements)
          # This is critical for Apple Silicon (M1/M2) support
          echo "Applying ad-hoc code signature to bundled binaries..."
          find appdynamics -name "*.so" -o -name "*.dylib" -o -name "Python" | xargs codesign --force -s - --preserve-metadata=identifier,entitlements
          codesign --force --deep -s - appdynamics/config-assessment-tool/*/config-assessment-tool

          # Determine the name of the PyInstaller created directory (e.g., 'config-assessment-tool')
          # Assumes PyInstaller creates a single top-level directory inside appdynamics/
          BUNDLE_DIR_PATH=$(find appdynamics -maxdepth 1 -mindepth 1 -type d)
          BUNDLE_DIR_NAME=$(basename "$BUNDLE_DIR_PATH")
          echo "PyInstaller created directory: ${BUNDLE_DIR_NAME}"

          # Get version from VERSION file for consistent naming
          VERSION_TAG=$(cat ../VERSION)
          echo "Version tag: ${VERSION_TAG}"

          # Define the output bundle filename
          BUNDLE_FILENAME="config-assessment-tool-macos-${VERSION_TAG}.zip"
          echo "Bundle filename: ${BUNDLE_FILENAME}"

          # Create the zip archive, including the appdynamics directory and excluding logs
          # The -x "appdynamics/*/logs/*" pattern excludes any 'logs' directory within the bundled application.
          zip -r "${BUNDLE_FILENAME}" appdynamics -x "appdynamics/*/logs/*"

          # Set output variable for subsequent steps
          echo "::set-output name=bundle_name::${BUNDLE_FILENAME}"
          echo "Current directory contents after zipping:"
          ls -altr

      - name: Release the bundle for macOS
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/${{ steps.build_bundle.outputs.bundle_name }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Keep workflow artifact within the current workflow namespace
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_bundle.outputs.bundle_name }}
          path: dist/${{ steps.build_bundle.outputs.bundle_name }}
          if-no-files-found: ignore