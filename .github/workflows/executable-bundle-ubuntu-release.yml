# .github/workflows/linux-release-bundle-ubuntu.yml
name: Create Ubuntu Linux Executable Bundle

on:
  release:
    types: [ published ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ubuntu-linux:
    name: build ubuntu linux binary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies and Build Bundle (Ubuntu)
        id: get_bundle_name # Added an ID to this step to capture output
        run: |
          # Ensure repository owner is lowercase for Docker tag
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="ghcr.io/${REPO_OWNER}/config-assessment-tool-ubuntu-linux:latest"

          # build image which builds the bundle for Ubuntu 20.x+
          # IMPORTANT: Use the new Dockerfile for Ubuntu
          make build-image DOCKERFILE=backend/Dockerfile-ubuntu DOCKER_IMAGE_TAG=${IMAGE_TAG}
          echo "finished building docker image with bundle included"
          # copy bundle out of built image
          # The `find` command is more robust for dynamically named files
          tarball_path=$(docker run --rm ${IMAGE_TAG} find /root/config-assessment-tool/dist/ -name "*.tgz")
          echo "copying bundle out of image using $tarball_path"
          docker cp $(docker create --name temp_image ${IMAGE_TAG}):$tarball_path ./ && docker rm temp_image
          echo "finished copying bundle onto hosted runner at $(pwd)"
          echo "files in current directory $(ls -altr)"
          # Capture the exact bundle filename
          BUNDLE_NAME=$(ls -1 *.tgz | head -n 1)
          echo "BUNDLE_NAME=$BUNDLE_NAME" >> $GITHUB_ENV # Set as an environment variable
          echo "bundle_name=$BUNDLE_NAME" >> $GITHUB_OUTPUT # Set as step output for clarity

      - name: Release the bundle for Ubuntu Linux
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.BUNDLE_NAME }} # Use the exact bundle name from environment variable
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Keep workflow artifact within the current workflow namespace (Ubuntu)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUNDLE_NAME }} # Use the exact bundle name for the artifact
          path: ./${{ env.BUNDLE_NAME }} # Specify the full path to the bundle
          if-no-files-found: ignore