# escape=`
# 1. Define the 'base' alias using the raw Windows Server Core image.
FROM mcr.microsoft.com/windows/servercore:ltsc2022 AS base

# Set the shell to PowerShell for the installation steps
SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# 2. Install Python manually
# Since 'servercore' doesn't have Python, we download the official installer.
ENV PYTHON_VERSION 3.9.13
RUN [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    Invoke-WebRequest -OutFile python-installer.exe https://www.python.org/ftp/python/$env:PYTHON_VERSION/python-$env:PYTHON_VERSION-amd64.exe ; `
    Start-Process python-installer.exe -ArgumentList '/quiet InstallAllUsers=1 PrependPath=1 TargetDir=C:\Python' -Wait ; `
    Remove-Item python-installer.exe

# 3. Explicitly set PATH in Docker env so subsequent stages can find 'python' and 'pip'
ENV PATH="C:\Python;C:\Python\Scripts;${PATH}"


# Stage 2: Dependency Exporter
FROM base AS builder

WORKDIR /app

COPY Pipfile .
COPY Pipfile.lock .

# pip is now available from the base stage
RUN pip install pipenv
RUN pipenv requirements > requirements.txt


# Stage 3: Final Runtime
FROM base AS runtime

WORKDIR /app

# 1. Copy the requirements file from the builder stage
COPY --from=builder /app/requirements.txt .

# 2. Install dependencies GLOBALLY
RUN pip install --no-cache-dir --upgrade pip ; `
    pip install --no-cache-dir -r requirements.txt

# 3. Copy application code
COPY backend /app/backend
COPY frontend /app/frontend
COPY VERSION .

# 4. Set PYTHONPATH
ENV PYTHONPATH="C:\app;C:\app\backend"

# 5. Create the entrypoint script
RUN Set-Content entrypoint.bat '@echo off' ; `
    Add-Content entrypoint.bat 'if /i "%1" == "backend" (' ; `
    Add-Content entrypoint.bat '  shift' ; `
    Add-Content entrypoint.bat '  python backend\backend.py %*' ; `
    Add-Content entrypoint.bat ') else (' ; `
    Add-Content entrypoint.bat '  python -m streamlit run frontend\frontend.py %*' ; `
    Add-Content entrypoint.bat ')'

EXPOSE 8501

ENTRYPOINT ["cmd", "/c", "entrypoint.bat"]
CMD ["frontend"]