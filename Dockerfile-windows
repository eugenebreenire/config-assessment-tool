# Stage 1: Dependency Exporter
# We use this stage only to convert Pipfile.lock into a requirements.txt
FROM base AS builder

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]
WORKDIR /app

COPY Pipfile .
COPY Pipfile.lock .

# Install pipenv just to generate requirements.txt
RUN pip install pipenv
RUN pipenv requirements > requirements.txt


# Stage 2: Final Runtime (Clean, Single Layer)
FROM base AS runtime

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]
WORKDIR /app

# 1. Copy the requirements file from the builder stage
COPY --from=builder /app/requirements.txt .

# 2. Install dependencies GLOBALLY (No Virtual Env)
# This installs libraries directly into C:\Python39\Lib\site-packages
RUN pip install --no-cache-dir --upgrade pip ; `
    pip install --no-cache-dir -r requirements.txt

# 3. Copy application code
COPY backend /app/backend
COPY frontend /app/frontend
COPY VERSION .

# 4. Set PYTHONPATH
# We do NOT need to add .venv to PATH anymore.
ENV PYTHONPATH="C:\app;C:\app\backend"

# 5. Create the entrypoint script
# We run 'python' directly. Since packages are global, this just works.
# CHANGE: executing 'python -m streamlit' ensures we don't rely on the PATH variable finding the .exe
RUN Set-Content entrypoint.bat '@echo off' ; `
    Add-Content entrypoint.bat 'if /i "%1" == "backend" (' ; `
    Add-Content entrypoint.bat '  shift' ; `
    Add-Content entrypoint.bat '  python backend\backend.py %*' ; `
    Add-Content entrypoint.bat ') else (' ; `
    Add-Content entrypoint.bat '  python -m streamlit run frontend\frontend.py %*' ; `
    Add-Content entrypoint.bat ')'

EXPOSE 8501

ENTRYPOINT ["cmd", "/c", "entrypoint.bat"]
CMD ["frontend"]